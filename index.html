<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Apontamento de Horas - Artia</title>

  <style>
    :root{
      --bg:#0f141b;--panel:#121a24;--panel2:#0e1722;--text:#e7eef7;--muted:#9fb0c3;
      --line:rgba(255,255,255,.08);--line2:rgba(255,255,255,.12);
      --accent:#4ea1ff;--accent2:#7bd3ff;--danger:#ff5c7a;--ok:#42d392;--warn:#ffc861;
      --shadow:0 10px 30px rgba(0,0,0,.35);--radius:14px;
      --timeColW:80px;--dayMinW:160px;--headerH:54px;--slotH:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:radial-gradient(1200px 600px at 20% 0%, rgba(78,161,255,.12), transparent 55%),
                 radial-gradient(900px 500px at 80% 20%, rgba(123,211,255,.10), transparent 55%),
                 var(--bg);
      color:var(--text);overflow:hidden;
    }

    header.topbar{
      position:sticky;top:0;z-index:50;
      display:grid;
      grid-template-columns:minmax(0,1fr) auto minmax(0,1fr);
      align-items:center;
      gap:10px;
      padding:6px 10px;
      min-height:54px;
      background:linear-gradient(180deg, rgba(18,26,36,.96), rgba(18,26,36,.88));
      border-bottom:1px solid var(--line);
      backdrop-filter:blur(10px);
    }
    /* Topbar: evita sobreposição do intervalo com botões */
    header.topbar .centerGroup{min-width:0}
    header.topbar .rangeSm{
      max-width:clamp(220px, 34vw, 420px);
      min-width:220px;
      overflow:hidden;
    }
    header.topbar .rangeSm strong{
      display:block;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    header.topbar .leftGroup,
    header.topbar .rightGroup{
      min-width:0;
      flex-wrap:wrap;
    }
    header.topbar .rightGroup{gap:8px}
    header.topbar .navGroup{gap:8px}

    .brand{display:flex;align-items:center;gap:10px;min-width:220px}
    .dot{width:10px;height:10px;border-radius:999px;background:var(--accent);box-shadow:0 0 0 4px rgba(78,161,255,.15)}
    .brand h1{margin:0;font-size:14px;font-weight:650;letter-spacing:.2px}
    .sub{font-size:12px;color:var(--muted);margin-left:6px}
    .toolbar{display:none}

    .leftGroup,.rightGroup{display:flex;align-items:center;gap:8px;min-width:0}
    .leftGroup{justify-content:flex-start}
    .rightGroup{justify-content:flex-end;flex-wrap:wrap;row-gap:6px}
    .navGroup{display:flex;align-items:center;gap:8px;min-width:0}
    .centerGroup{display:flex;align-items:center;justify-content:center;min-width:0}

    .baseMini{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;
      border:1px solid var(--line);background:rgba(0,0,0,.18);
      color:var(--muted);font-size:12px;white-space:nowrap;
    }
    .baseMini .miniDot{width:8px;height:8px;border-radius:999px;background:rgba(255,255,255,.20)}
    .baseMini.ok .miniDot{background:var(--ok);box-shadow:0 0 0 4px rgba(66,211,146,.12)}
    .baseMini.warn .miniDot{background:var(--warn);box-shadow:0 0 0 4px rgba(255,200,97,.12)}

    .btnSm{padding:7px 10px;font-size:12px;border-radius:9px}
    .rangeSm{padding:7px 10px;border-radius:10px;min-width:unset}
    .statusSm{padding:6px 10px;border-radius:999px;font-size:12px}

    /* Mantém tudo em uma linha no desktop sem precisar de scroll */
    header.topbar .leftGroup, header.topbar .rightGroup{flex-wrap:wrap}
    header.topbar .rightGroup{gap:10px}
    header.topbar .navGroup{gap:10px}


    .leftGroup,.rightGroup{display:flex;align-items:center;gap:8px;min-width:0}
    .leftGroup{justify-content:flex-start}
    .rightGroup{justify-content:flex-end}
    .navGroup{display:flex;align-items:center;gap:8px;min-width:0}
    .centerGroup{display:flex;align-items:center;justify-content:center;min-width:0}

    .baseMini{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;
      border:1px solid var(--line);background:rgba(0,0,0,.18);color:var(--muted);font-size:12px;white-space:nowrap}
    .baseMini .miniDot{width:8px;height:8px;border-radius:999px;background:rgba(255,255,255,.22)}
    .baseMini.ok .miniDot{background:var(--ok);box-shadow:0 0 0 4px rgba(66,211,146,.12)}
    .baseMini.warn .miniDot{background:var(--warn);box-shadow:0 0 0 4px rgba(255,200,97,.12)}
    .baseMini .miniText{letter-spacing:.2px}

    .btnSm{padding:7px 10px;font-size:12px;border-radius:9px}
    .rangeSm{padding:7px 10px;min-width:240px;font-size:12px;border-radius:10px}
    .statusSm{padding:6px 9px;font-size:12px;border-radius:999px}
    .statusSm .statusDot{width:8px;height:8px}

    .toolbar::-webkit-scrollbar{height:10px}
    .toolbar::-webkit-scrollbar-thumb{background:rgba(255,255,255,.12);border-radius:999px;border:3px solid rgba(0,0,0,0);background-clip:padding-box}
    .toolbar::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,.18);background-clip:padding-box}
    .spacer{flex:1 1 auto;min-width:12px}

    .btn{
      appearance:none;border:1px solid var(--line2);background:rgba(255,255,255,.04);
      color:var(--text);padding:9px 12px;border-radius:10px;font-size:13px;cursor:pointer;
      transition:transform .05s ease, background .15s ease, border-color .15s ease;user-select:none;white-space:nowrap;
    }
    .btn:hover{background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.18)}
    .btn:active{transform:translateY(1px)}
    .btn.primary{border-color:rgba(78,161,255,.45);background:rgba(78,161,255,.12)}
    .btn.danger{border-color:rgba(255,92,122,.45);background:rgba(255,92,122,.10)}
    .btn.ghost{background:transparent;border-color:var(--line)}

    .range{
      display:flex;align-items:center;gap:10px;padding:9px 12px;border-radius:12px;
      border:1px solid var(--line);background:rgba(0,0,0,.18);min-width:260px;justify-content:center;font-size:13px;
    }
    .range strong{font-weight:650;letter-spacing:.2px}

    .statusPill{
      display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;border:1px solid var(--line);
      background:rgba(0,0,0,.18);color:var(--muted);font-size:12px;white-space:nowrap;
    }
    .statusDot{width:8px;height:8px;border-radius:999px;background:rgba(255,255,255,.22)}
    .statusPill.ok .statusDot{background:var(--ok);box-shadow:0 0 0 4px rgba(66,211,146,.12)}
    .statusPill.warn .statusDot{background:var(--warn);box-shadow:0 0 0 4px rgba(255,200,97,.12)}

    .app{height:calc(100vh - var(--headerH));display:flex;flex-direction:column;overflow:hidden}
    .gridWrap{position:relative;height:100%;overflow:auto;scrollbar-gutter:stable both-edges;padding:10px 12px 14px}
    .gridWrap::-webkit-scrollbar{width:12px;height:12px}
    .gridWrap::-webkit-scrollbar-thumb{
      background:rgba(255,255,255,.12);border-radius:999px;border:3px solid rgba(0,0,0,0);background-clip:padding-box;
    }
    .gridWrap::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,.18);background-clip:padding-box}

    .daysHeader{
      position:sticky;top:0;z-index:20;display:grid;
      grid-template-columns:var(--timeColW) repeat(7, minmax(var(--dayMinW), 1fr));
      background:linear-gradient(180deg, rgba(14,23,34,.98), rgba(14,23,34,.92));
      border:1px solid var(--line);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow);
    }
    .daysHeader .cell{
      padding:10px 10px;border-right:1px solid var(--line);
      display:flex;flex-direction:column;gap:2px;justify-content:center;min-height:66px;
    }
    .daysHeader .cell:last-child{border-right:none}
    .daysHeader .timeHead{
      color:var(--muted);font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:.8px;align-items:flex-start;
    }
    .dayName{font-size:12px;color:var(--muted);letter-spacing:.2px}
    .dayDate{font-size:14px;font-weight:650}
    .todayPill{display:inline-flex;align-items:center;gap:6px;margin-top:3px;color:var(--accent2);font-size:11px;font-weight:650;letter-spacing:.2px}
    .todayPill span{width:6px;height:6px;border-radius:999px;background:var(--accent2);box-shadow:0 0 0 4px rgba(123,211,255,.12)}

    .worked{
      margin-top:6px;display:flex;align-items:center;gap:8px;font-size:11px;color:rgba(231,238,247,.88);letter-spacing:.2px;
    }
    .worked b{font-weight:750;color:var(--accent2);font-variant-numeric: tabular-nums;}
    .worked .chip{
      display:inline-flex;align-items:center;gap:6px;padding:3px 8px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.18);color:rgba(231,238,247,.88);white-space:nowrap;
    }
    .worked .chip .miniDot{
      width:6px;height:6px;border-radius:999px;background:rgba(66,211,146,.9);box-shadow:0 0 0 4px rgba(66,211,146,.12)
    }

    .weekGrid{
      margin-top:10px;position:relative;display:grid;
      grid-template-columns:var(--timeColW) repeat(7, minmax(var(--dayMinW), 1fr));
      border:1px solid var(--line);border-radius:var(--radius);overflow:hidden;
      background:linear-gradient(180deg, rgba(18,26,36,.65), rgba(18,26,36,.35));
      box-shadow:var(--shadow);user-select:none;
    }
    .timeCol{background:rgba(0,0,0,.20);border-right:1px solid var(--line);position:relative;z-index:2}
    .dayCol{position:relative;border-right:1px solid var(--line);background:rgba(0,0,0,.10)}
    .dayCol:last-child{border-right:none}
    .slots{position:relative}
    .slotRow{height:var(--slotH);border-top:1px solid var(--line);position:relative}
    .slotRow.major{border-top-color:rgba(255,255,255,.14)}
    .timeLabel{
      height:calc(var(--slotH) * 6);border-top:1px solid rgba(255,255,255,.14);
      display:flex;align-items:flex-start;justify-content:flex-end;padding:6px 10px 0 8px;
      color:var(--muted);font-size:12px;font-variant-numeric:tabular-nums;letter-spacing:.2px;
    }

    .selectionBlock{
      position:absolute;left:6px;right:6px;border-radius:12px;background:rgba(78,161,255,.16);
      border:1px solid rgba(78,161,255,.45);box-shadow:0 0 0 4px rgba(78,161,255,.08);pointer-events:none;z-index:6;
    }
    .selectionHint{
      position:absolute;top:-28px;left:6px;background:rgba(0,0,0,.55);border:1px solid var(--line2);
      padding:6px 8px;border-radius:10px;font-size:12px;color:var(--text);pointer-events:none;white-space:nowrap;box-shadow:var(--shadow);
    }

    .event{
      position:absolute;left:6px;right:6px;border-radius:12px;background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);box-shadow:0 8px 20px rgba(0,0,0,.28);
      padding:8px 10px;cursor:pointer;z-index:8;overflow:hidden;
    }
    .event:hover{border-color:rgba(78,161,255,.35);background:rgba(78,161,255,.10)}
    .event.dragging{
      opacity:.92;border-color:rgba(123,211,255,.55);background:rgba(78,161,255,.16);
      box-shadow:0 10px 24px rgba(0,0,0,.45);z-index:30;
    }
    .event .topline{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:4px}

    .badge{
      display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;
      background:rgba(78,161,255,.14);border:1px solid rgba(78,161,255,.30);color:var(--accent2);
      font-size:11px;font-weight:700;letter-spacing:.2px;white-space:nowrap;
    }
    .badge[data-pcolor="0"]{background:rgba(66,211,146,.18);border-color:#42d392;color:#42d392;}
    .badge[data-pcolor="1"]{background:rgba(255,200,97,.20);border-color:#ffc861;color:#ffc861;}
    .badge[data-pcolor="2"]{background:rgba(255,159,67,.22);border-color:#ff9f43;color:#ff9f43;}
    .badge[data-pcolor="3"]{background:rgba(78,161,255,.22);border-color:#4ea1ff;color:#4ea1ff;}
    .badge[data-pcolor="4"]{background:rgba(155,89,182,.22);border-color:#9b59b6;color:#9b59b6;}
    .badge[data-pcolor="5"]{background:rgba(52,152,219,.22);border-color:#3498db;color:#3498db;}
    .badge[data-pcolor="6"]{background:rgba(231,76,60,.22);border-color:#e74c3c;color:#e74c3c;}
    .badge[data-pcolor="7"]{background:rgba(26,188,156,.22);border-color:#1abc9c;color:#1abc9c;}
    .badge[data-pcolor="8"]{background:rgba(241,196,15,.22);border-color:#f1c40f;color:#f1c40f;}
    .badge[data-pcolor="9"]{background:rgba(149,165,166,.22);border-color:#95a5a6;color:#95a5a6;}

    .times{color:var(--muted);font-size:11px;font-variant-numeric:tabular-nums;white-space:nowrap}
    .title{font-size:12px;font-weight:650;letter-spacing:.2px;margin-bottom:2px}
    .notes{
      font-size:12px;color:rgba(231,238,247,.86);line-height:1.2;display:-webkit-box;
      -webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;
    }

    /* ===== Tabela (visão alternativa) ===== */
    .tableTop{
      display:flex;justify-content:flex-end;align-items:center;gap:8px;
      margin:0 2px 10px;
    }
    .tableTop .btn{box-shadow:var(--shadow)}

    .tableWrap{
      margin-top:10px;border:1px solid var(--line);border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(18,26,36,.72), rgba(18,26,36,.40));
      box-shadow:var(--shadow);
      overflow:auto;
    }
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      min-width:980px;
    }
    thead th{
      position:sticky;top:0;z-index:5;
      text-align:left;
      font-size:12px;
      color:rgba(231,238,247,.92);
      background:rgba(14,23,34,.98);
      border-bottom:1px solid var(--line);
      padding:10px 10px;
      white-space:nowrap;
      font-weight:750;
      letter-spacing:.2px;
    }
    tbody td{
      padding:10px 10px;
      border-bottom:1px solid rgba(255,255,255,.06);
      color:rgba(231,238,247,.92);
      font-size:13px;
      vertical-align:top;
    }
    tbody tr{
      cursor:pointer;
      transition:background .12s ease;
    }
    tbody tr:hover{
      background:rgba(78,161,255,.10);
    }
    .tdMuted{color:rgba(159,176,195,.92);font-size:12px;white-space:nowrap}
    .tdMono{font-variant-numeric: tabular-nums;white-space:nowrap}
    .tdNotes{
      color:rgba(231,238,247,.88);
      max-width:520px;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
    }
    .tagProject{
      display:inline-flex;align-items:center;gap:8px;
    }


    /* ===== Botões de visão (Calendário / Tabela / Gantt) ===== */
    .viewBtns{display:flex;align-items:center;gap:6px;row-gap:6px;min-width:0;flex-wrap:wrap;justify-content:flex-end}
    .btn.active{
      border-color:rgba(78,161,255,.60);
      background:rgba(78,161,255,.18);
    }

    /* ===== Gantt (visão por projeto) ===== */
    .ganttControls{
      margin-top:10px;
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .ganttControls .ctrlLabel{font-size:12px;color:var(--muted);letter-spacing:.2px}
    .ganttControls .ctrlSelect{
      min-width:240px;
      max-width:360px;
    }
    .ganttWrap{
      margin-top:10px;
      border:1px solid var(--line);
      border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(18,26,36,.72), rgba(18,26,36,.40));
      box-shadow:var(--shadow);
      overflow:auto;
    }
    table.gantt{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      min-width:980px;
    }
    table.gantt thead th{
      position:sticky;top:0;z-index:5;
      text-align:center;
      font-size:12px;
      color:rgba(231,238,247,.92);
      background:rgba(14,23,34,.98);
      border-bottom:1px solid var(--line);
      padding:10px 10px;
      white-space:nowrap;
      font-weight:750;
      letter-spacing:.2px;
    }
    table.gantt thead th.left{text-align:left}
    table.gantt tbody td{
      padding:10px 10px;
      border-bottom:1px solid rgba(255,255,255,.06);
      color:rgba(231,238,247,.92);
      font-size:13px;
      vertical-align:middle;
      text-align:center;
      font-variant-numeric: tabular-nums;
    }
    table.gantt tbody td.left{text-align:left}
    table.gantt tbody tr:hover{background:rgba(78,161,255,.08)}
    .gCell{
      border-left:1px solid rgba(255,255,255,.06);
      border-right:1px solid rgba(255,255,255,.06);
    }
    .gCell.on{
      background:rgba(78,161,255,.22);
      border-color:rgba(78,161,255,.28);
      color:#07121f;
      font-weight:800;
    }
    .gCell.on span{
      display:inline-block;
      padding:4px 8px;
      border-radius:10px;
      background:rgba(255,255,255,.65);
      color:#06121f;
      border:1px solid rgba(0,0,0,.12);
    }

    .modalBackdrop{
      position:fixed;inset:0;background:rgba(0,0,0,.62);display:none;align-items:center;justify-content:center;
      z-index:999;padding:14px;
    }
    .modalBackdrop.show{display:flex}
    .modal{
      width:min(720px, 100%);border-radius:18px;border:1px solid rgba(255,255,255,.10);
      background:linear-gradient(180deg, rgba(18,26,36,.98), rgba(14,23,34,.94));
      box-shadow:0 18px 60px rgba(0,0,0,.55);overflow:hidden;
    }
    .modalHeader{display:flex;align-items:flex-start;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--line);gap:10px}

    .modalActions{display:flex;align-items:center;gap:8px}
    .btn:disabled{opacity:.5;cursor:not-allowed;transform:none}
    .modalHeader h2{margin:0;font-size:14px;font-weight:750;letter-spacing:.2px}
    .modalHeader .when{margin-top:4px;color:var(--muted);font-size:12px;font-variant-numeric:tabular-nums;line-height:1.25}
    .xBtn{
      appearance:none;border:1px solid var(--line2);background:rgba(255,255,255,.04);color:var(--text);
      border-radius:12px;width:38px;height:38px;cursor:pointer;font-size:16px;line-height:1;
    }
    .xBtn:hover{background:rgba(255,255,255,.06)}
    .modalBody{padding:14px 16px 10px;display:grid;gap:12px}
    .row{display:grid;gap:8px}
    .row.grid2{grid-template-columns:1fr 1fr;gap:10px}
    label{font-size:12px;color:var(--muted);letter-spacing:.2px}

    /* Contraste melhor nos selects (horários + atividades) */
    select{
      background:#e8eef6 !important;
      color:#000 !important;
      border:1px solid rgba(0,0,0,.18) !important;
    }
    select:focus{
      border-color: rgba(78,161,255,.60) !important;
      box-shadow: 0 0 0 4px rgba(78,161,255,.12) !important;
    }
    select option{ color:#000; background:#fff; }

    textarea, input[type="text"]{
      width:100%;background:rgba(0,0,0,.18);border:1px solid var(--line2);color:var(--text);
      border-radius:12px;padding:10px 12px;outline:none;font-size:13px;
    }
    textarea:focus, input[type="text"]:focus{
      border-color:rgba(78,161,255,.50);box-shadow:0 0 0 4px rgba(78,161,255,.10)
    }
    textarea{min-height:88px;resize:vertical;line-height:1.25}
    .hint{font-size:12px;color:rgba(159,176,195,.85);line-height:1.25}

    .idAutoPill{
      display:inline-flex;align-items:center;gap:8px;padding:7px 10px;border-radius:999px;border:1px solid var(--line);
      background:rgba(0,0,0,.14);color:var(--muted);font-size:12px;
    }
    .idAutoPill.ok{border-color:rgba(66,211,146,.35);background:rgba(66,211,146,.10);color:rgba(214,255,236,.92)}
    .idAutoPill.warn{border-color:rgba(255,200,97,.35);background:rgba(255,200,97,.10);color:rgba(255,240,210,.92)}
    .idAutoPill .b{width:8px;height:8px;border-radius:999px;background:rgba(255,255,255,.20)}
    .idAutoPill.ok .b{background:var(--ok);box-shadow:0 0 0 4px rgba(66,211,146,.12)}
    .idAutoPill.warn .b{background:var(--warn);box-shadow:0 0 0 4px rgba(255,200,97,.12)}

    .modalFooter{display:flex;gap:10px;justify-content:flex-end;padding:12px 16px 16px;border-top:1px solid var(--line)}
    .pill{margin-right:auto;display:flex;align-items:center;gap:10px;color:var(--muted);font-size:12px}
    .hidden{display:none !important}

    @media (max-width:760px){
      header.topbar{grid-template-columns:1fr;row-gap:8px}
      .leftGroup,.centerGroup,.rightGroup{justify-content:flex-start;flex-wrap:wrap}
      .centerGroup{justify-content:flex-start}
      .rangeSm{min-width:unset;width:100%}

      header{height:auto;padding:10px 12px}
      .brand{min-width:unset}
      .range{width:auto;margin-left:0;justify-content:center}
      .toolbar{overflow-x:auto;flex-wrap:nowrap}
      .toolbar{gap:8px}
      .btn{padding:9px 10px}
      .row.grid2{grid-template-columns:1fr}
      table{min-width:940px}
    }
  </style>
</head>

<body>
<header class="topbar">
  <div class="leftGroup">
    <div class="statusPill warn statusSm" id="baseStatus" title="Base IDs">
      <span class="statusDot"></span><span id="baseStatusText">Base local</span>
    </div>

    <div class="navGroup">
      <button class="btn ghost btnSm" id="btnPrev">‹ Sem. anterior</button>
      <button class="btn primary btnSm" id="btnToday">Hoje</button>
      <button class="btn ghost btnSm" id="btnNext">Prox. semana ›</button>
    </div>
  </div>

  <div class="centerGroup">
    <div class="range rangeSm"><strong id="weekRangeText">--/--/---- → --/--/----</strong></div>
  </div>

  <div class="rightGroup">
    <div class="viewBtns">
      <button class="btn btnSm active" id="btnViewCalendar">Calendário</button>
      <button class="btn btnSm" id="btnViewTable">Tabela</button>
      <button class="btn btnSm" id="btnViewGantt">Gantt</button>
    </div>
    <button class="btn btnSm" id="btnExportCsv">Exportar CSV</button>
    <button class="btn btnSm" id="btnLoadBase">Carregar IDs (XLSX)</button>
    <input id="fileBaseInput" type="file" accept=".xlsx" class="hidden" />
    <button class="btn danger btnSm" id="btnClearWeek">Limpar Semana</button>
    <button class="btn danger btnSm" id="btnClearAll">Limpar Tudo</button>
  </div>
</header>

<div class="app">
  <div class="gridWrap" id="gridWrap">
    <div class="daysHeader" id="daysHeader"></div>

    <div id="calendarView">
      <div class="weekGrid" id="weekGrid"></div>
    </div>

    <div id="tableView" class="hidden">
      <div class="tableTop">
        <button class="btn primary btnSm" id="btnNewFromTable" type="button">+ Novo apontamento</button>
      </div>
      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th>Data</th>
              <th>Projeto</th>
              <th>Hora Início</th>
              <th>Hora de Término</th>
              <th>Esforço</th>
              <th>Esforço Dia</th>
              <th>Atividade</th>
              <th>Observação</th>
              <th>ID</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
      <div class="hint" style="margin-top:10px;">
        Dica: clique em uma linha para editar o evento.
      </div>
    </div>

    <div id="ganttView" class="hidden">
      <div class="ganttControls">
        <div class="ctrlLabel">Projeto:</div>
        <select id="ganttProjectFilter" class="ctrlSelect"></select>
        <div class="hint">Mostra o total de horas por projeto e por dia na semana atual.</div>
      </div>

      <div class="ganttWrap">
        <table class="gantt">
          <thead>
            <tr>
              <th class="left">Projeto</th>
              <th>Total Horas na Semana</th>
              <th>seg</th>
              <th>ter</th>
              <th>qua</th>
              <th>qui</th>
              <th>sex</th>
              <th>sáb</th>
              <th>dom</th>
            </tr>
          </thead>
          <tbody id="ganttBody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<div class="modalBackdrop" id="modalBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal">
    <div class="modalHeader">
      <div>
        <h2 id="modalTitle">Novo evento</h2>
        <div class="when" id="modalWhen">--/--/---- --:-- → --/--/---- --:--</div>
      </div>
      <div class="modalActions">
        <button class="btn ghost btnSm" id="btnCopyFields" type="button" title="Copiar Projeto/Atividade/ID/Observação">Copiar</button>
        <button class="btn ghost btnSm" id="btnPasteFields" type="button" title="Colar Projeto/Atividade/ID/Observação">Colar</button>
        <button class="xBtn" id="modalClose" title="Fechar">✕</button>
      </div>
    </div>

    <div class="modalBody">
      <div class="row grid2">
        <div class="row">
          <label for="startTimeSelect">Início (HH:MM)</label>
          <select id="startTimeSelect"></select>
        </div>
        <div class="row">
          <label for="endTimeSelect">Fim (HH:MM)</label>
          <select id="endTimeSelect"></select>
        </div>
      </div>
      <div class="hint">Os horários são em intervalos de 10 minutos. “24:00” representa o final do dia.</div>

      <div class="row">
        <label for="projectInput">Projeto (nº do projeto)</label>
        <input type="text" id="projectInput" placeholder="Ex.: 1360" autocomplete="off" />
      </div>

      <div class="row">
        <label for="activityNameSelect">Atividade (Nome)</label>
        <select id="activityNameSelect"></select>
      </div>

      <div class="row grid2">
        <div class="row">
          <label for="activityIdInput">ID Artia (varia por projeto e por atividade)</label>
          <input type="text" id="activityIdInput" placeholder="Preenchido automaticamente se existir na base" autocomplete="off" />
        </div>
        <div class="row" style="align-content:end;">
          <div class="idAutoPill warn" id="idLookupPill">
            <span class="b"></span>
            <span id="idLookupText">ID: preencha manualmente (base não consultada)</span>
          </div>
        </div>
      </div>

      <div class="row">
        <label for="notesInput">Observação</label>
        <textarea id="notesInput" placeholder="Escreva observações..."></textarea>
      </div>
    </div>

    <div class="modalFooter">
      <div class="pill">
        <span id="modalInfo" class="hidden">⚠</span>
        <span id="modalInfoText"></span>
      </div>
      <button class="btn danger hidden" id="btnDelete">Apagar</button>
      <button class="btn ghost" id="btnCancel">Cancelar</button>
      <button class="btn primary" id="btnSave">Salvar</button>
    </div>
  </div>
</div>

<script>
  const LS_EVENTS_KEY="offline_week_calendar_events_v5";
  const LS_IDBASE_KEY="offline_week_calendar_idbase_index_v1";
  const LS_IDBASE_META_KEY="offline_week_calendar_idbase_meta_v1";
  const LS_CLIP_KEY="offline_week_calendar_clipboard_fields_v1";
  const CONFIG={startHour:0,endHour:24,stepMinutes:10};
  const DAY_NAMES=["Segunda","Terça","Quarta","Quinta","Sexta","Sábado","Domingo"];

  function pad2(n){return String(n).padStart(2,"0")}
  function toDateOnlyISO(d){return d.getFullYear()+"-"+pad2(d.getMonth()+1)+"-"+pad2(d.getDate())}
  function formatDateBR(d){return pad2(d.getDate())+"/"+pad2(d.getMonth()+1)+"/"+d.getFullYear()}
  function parseISOToLocalDate(iso){const [y,m,da]=iso.split("-").map(Number);return new Date(y,m-1,da,0,0,0,0)}
  function addDays(d,days){const nd=new Date(d);nd.setDate(nd.getDate()+days);return nd}
  function startOfWeekMonday(date){
    const d=new Date(date.getFullYear(),date.getMonth(),date.getDate(),0,0,0,0);
    const dow=d.getDay();const diff=(dow===0)?-6:(1-dow);d.setDate(d.getDate()+diff);return d;
  }
  function setTimeOnDate(dateOnly,hh,mm){return new Date(dateOnly.getFullYear(),dateOnly.getMonth(),dateOnly.getDate(),hh,mm,0,0)}
  function minutesFromDayStart(dateTime,dayIso){const base=parseISOToLocalDate(dayIso);return Math.round((dateTime.getTime()-base.getTime())/60000)}
  function durationMinutes(a,b){return (b.getTime()-a.getTime())/60000}
  function normalizeToStepMinutes(m){const step=CONFIG.stepMinutes;return Math.round(m/step)*step}
  function clampMinutesToDay(m){ if(m<0)m=0; if(m>1440)m=1440; return normalizeToStepMinutes(m); }
  function formatTimeFromMinutes(m){
    m = clampMinutesToDay(m);
    if(m===1440) return "24:00";
    const hh=Math.floor(m/60), mm=m%60;
    return pad2(hh)+":"+pad2(mm);
  }
  function formatDateTimeBRFromDay(dateTime,dayIso){
    const base=parseISOToLocalDate(dayIso);
    const m=clampMinutesToDay(minutesFromDayStart(dateTime,dayIso));
    return formatDateBR(base)+" "+formatTimeFromMinutes(m);
  }
  function escapeHtml(s){
    return String(s??"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }
  function normKey(s){
    return String(s??"").trim().toLowerCase().replace(/\s+/g," ").replace(/[–—]/g,"-").replace(/\s*-\s*/g," - ").replace(/\u00A0/g," ");
  }
  function extractProjectFromC(valC){
    const s=String(valC??"").trim();const m=s.match(/\b(\d{3,})\b/);return m?m[1]:"";
  }
  function projectColorDigit(project){
    const m = String(project||"").match(/(\d)\s*$/);
    return m ? m[1] : "0";
  }

  const ACTIVITY_NAMES=[
    "1.5 - Leitura da documentação","1.1 - Organização de Documentos","2.1 - Reuniões com Cliente",
    "3.6 - Levantamento de Medições","4.3 - Linha do Tempo","5.1 - Narrativa Problemas",
    "5.3 - Adequação e Revisão do Pleito","5.2 - Capítulo de Custos","6.6 - Redação de Carta a Pedido do Cliente",
    "107 - Outros (especificar nos comentários)","105 - Comunicação Interna","4.1 - Levantamento de Impactos",
    "2.4 - Gerenciamento","1.7 - Desenhos ou Layouts","8.1 - Realinhamento dos Preços do Contrato",
    "6.2 - Relatório de Acompanhamento","6 - Elaboração de Demandas Específicas","7.10 - Elaboração de Apresentação",
    "4.2 - Estudo de Cronograma","2.2 - Contato com Cliente","2.3 - Consultoria com Outros Membros da Empresa",
    "6.9 - Visita de Acompanhamento","0000.2.1 - Criação e Atualização do Artia","8.1 - Reequilíbrio Econômico-Financeiro"
  ];

  const EXAMPLE_EVENTS=[
    {id:"ex1",start:"2026-01-19T09:00:00",end:"2026-01-19T10:00:00",day:"2026-01-19",project:"1360",activityId:"R01",activityLabel:"Reunião",notes:"Alinhamento de reajuste contratual"},
    {id:"ex2",start:"2026-01-20T14:00:00",end:"2026-01-20T16:00:00",day:"2026-01-20",project:"1377",activityId:"A10",activityLabel:"Análise",notes:"Análise preliminar de documentos"},
    {id:"ex3",start:"2026-01-21T08:30:00",end:"2026-01-21T11:00:00",day:"2026-01-21",project:"1182",activityId:"P20",activityLabel:"Parecer",notes:"Parecer técnico – versão preliminar"},
    {id:"ex4",start:"2026-01-22T15:00:00",end:"2026-01-22T17:30:00",day:"2026-01-22",project:"1401",activityId:"V30",activityLabel:"Valuation/PPA",notes:"Discussão de premissas do PPA"}
  ];

  let state={
    weekStart:startOfWeekMonday(new Date()),
    events:[],
    selection:null,
    editingEventId:null,
    idBaseIndex:null,
    idBaseMeta:null,
    view:"calendar" // "calendar" | "table" | "gantt"
  };

  function loadEvents(){
    const raw=localStorage.getItem(LS_EVENTS_KEY);
    if(!raw){state.events=EXAMPLE_EVENTS.map(e=>({...e}));saveEvents();return true;}
    try{const parsed=JSON.parse(raw);state.events=Array.isArray(parsed)?parsed:[];}catch{state.events=[];}
    return false;
  }
  function saveEvents(){localStorage.setItem(LS_EVENTS_KEY, JSON.stringify(state.events));}

  /* ===== Clipboard (copiar/colar campos do evento) ===== */
  function getClipboardFields(){
    try{
      const raw = localStorage.getItem(LS_CLIP_KEY);
      if(!raw) return null;
      const obj = JSON.parse(raw);
      if(!obj || typeof obj!=="object") return null;
      return {
        project: String(obj.project??""),
        activityLabel: String(obj.activityLabel??""),
        activityId: String(obj.activityId??""),
        notes: String(obj.notes??"")
      };
    }catch{return null;}
  }
  function setClipboardFields(obj){
    try{
      const payload = {
        project: String(obj?.project??""),
        activityLabel: String(obj?.activityLabel??""),
        activityId: String(obj?.activityId??""),
        notes: String(obj?.notes??""),
        savedAt: new Date().toISOString()
      };
      localStorage.setItem(LS_CLIP_KEY, JSON.stringify(payload));
    }catch{}
  }
  function ensureSelectHasValue(selectEl, value){
    const v = String(value??"").trim();
    if(!v) return;
    const exists = Array.from(selectEl.options).some(o=>o.value===v);
    if(!exists){
      const opt=document.createElement("option");
      opt.value=v; opt.textContent=v;
      selectEl.appendChild(opt);
    }
  }

  function loadIdBaseFromStorage(){
    try{
      const idx=JSON.parse(localStorage.getItem(LS_IDBASE_KEY)||"null");
      const meta=JSON.parse(localStorage.getItem(LS_IDBASE_META_KEY)||"null");
      if(idx && typeof idx==="object"){state.idBaseIndex=idx;state.idBaseMeta=meta;setBaseStatus(true,meta);return true;}
    }catch{}
    state.idBaseIndex=null;state.idBaseMeta=null;setBaseStatus(false,null);return false;
  }
  function saveIdBaseToStorage(indexObj,metaObj){
    localStorage.setItem(LS_IDBASE_KEY, JSON.stringify(indexObj));
    localStorage.setItem(LS_IDBASE_META_KEY, JSON.stringify(metaObj));
    state.idBaseIndex=indexObj;state.idBaseMeta=metaObj;setBaseStatus(true,metaObj);
  }
  function clearAll(){state.events=[];saveEvents();renderAll();}
  function clearWeek(){
    const ws=toDateOnlyISO(state.weekStart), we=toDateOnlyISO(addDays(state.weekStart,6));
    state.events=state.events.filter(ev=>!(ev.day>=ws && ev.day<=we));saveEvents();renderAll();
  }

  const baseStatusEl=document.getElementById("baseStatus");
  const baseMiniEl=document.getElementById("baseMini");
  const baseMiniTextEl=document.getElementById("baseMiniText");
  const baseStatusTextEl=document.getElementById("baseStatusText");
  function setBaseStatus(loaded,meta){
    baseStatusEl.classList.remove("ok","warn");
    baseStatusEl.classList.add(loaded?"ok":"warn");
    if(!loaded){baseStatusTextEl.textContent="IDs: não carregada";
      if(baseMiniEl){baseMiniEl.classList.remove("ok");baseMiniEl.classList.add("warn");}
      if(baseMiniTextEl){baseMiniTextEl.textContent="Base local";}
      return;}
    const rows=meta?.rows??"?";const fileName=meta?.fileName??"arquivo";
    baseStatusTextEl.textContent=`IDs: carregada (${rows} linhas)`;
    if(baseMiniEl){baseMiniEl.classList.remove("warn");baseMiniEl.classList.add("ok");}
    if(baseMiniTextEl){baseMiniTextEl.textContent="Base local";}baseStatusEl.title=`Fonte: ${fileName}`;
  }

  const daysHeaderEl=document.getElementById("daysHeader");
  const weekGridEl=document.getElementById("weekGrid");
  const weekRangeTextEl=document.getElementById("weekRangeText");
  const calendarViewEl=document.getElementById("calendarView");
  const tableViewEl=document.getElementById("tableView");
  const tableBodyEl=document.getElementById("tableBody");
  const btnViewCalendar=document.getElementById("btnViewCalendar");
  const btnViewTable=document.getElementById("btnViewTable");
  const btnViewGantt=document.getElementById("btnViewGantt");
  const ganttViewEl=document.getElementById("ganttView");
  const ganttBodyEl=document.getElementById("ganttBody");
  const ganttProjectFilterEl=document.getElementById("ganttProjectFilter");

  let dayCols=[], dayIsoList=[];

  function computeWeekDays(){
    dayIsoList=[];const ws=state.weekStart;
    for(let i=0;i<7;i++) dayIsoList.push(toDateOnlyISO(addDays(ws,i)));
  }

  function sumWorkedMinutesForDay(dayIso){
    let total=0;
    for(const ev of state.events){
      if(ev.day!==dayIso) continue;
      total += Math.max(0, durationMinutes(new Date(ev.start), new Date(ev.end)));
    }
    return Math.round(total);
  }
  function formatWorkedHM(mins){
    const h=Math.floor(mins/60);
    const m=mins%60;
    return pad2(h)+":"+pad2(m);
  }

  function renderHeader(){
    computeWeekDays();
    const ws=state.weekStart, we=addDays(ws,6);
    weekRangeTextEl.textContent=`${formatDateBR(ws)} → ${formatDateBR(we)}`;
    daysHeaderEl.innerHTML="";

    const timeHead=document.createElement("div");
    timeHead.className="cell timeHead";
    timeHead.textContent="Horários";
    daysHeaderEl.appendChild(timeHead);

    const todayIso=toDateOnlyISO(new Date());
    for(let i=0;i<7;i++){
      const dayIso=dayIsoList[i];
      const d=parseISOToLocalDate(dayIso);

      const cell=document.createElement("div");
      cell.className="cell";

      const nm=document.createElement("div");nm.className="dayName";nm.textContent=DAY_NAMES[i];
      const dt=document.createElement("div");dt.className="dayDate";dt.textContent=formatDateBR(d);
      cell.appendChild(nm);cell.appendChild(dt);

      if(dayIso===todayIso){
        const pill=document.createElement("div");
        pill.className="todayPill";
        pill.innerHTML="<span></span>Hoje";
        cell.appendChild(pill);
      }

      const workedMin = sumWorkedMinutesForDay(dayIso);
      const worked = document.createElement("div");
      worked.className = "worked";
      worked.innerHTML = `<span class="chip"><span class="miniDot"></span>Tempo Trabalhado: <b>${formatWorkedHM(workedMin)}</b></span>`;
      cell.appendChild(worked);

      daysHeaderEl.appendChild(cell);
    }
  }

  function buildTimeColumn(){
    const col=document.createElement("div");col.className="timeCol";
    const slotsWrap=document.createElement("div");slotsWrap.className="slots";
    for(let h=CONFIG.startHour;h<CONFIG.endHour;h++){
      const label=document.createElement("div");label.className="timeLabel";label.textContent=pad2(h)+":00";
      slotsWrap.appendChild(label);
    }
    col.appendChild(slotsWrap);return col;
  }
  function buildDayColumn(dayIso,totalSlots){
    const col=document.createElement("div");col.className="dayCol";col.dataset.dayIso=dayIso;
    const slotsWrap=document.createElement("div");slotsWrap.className="slots";
    for(let i=0;i<totalSlots;i++){
      const row=document.createElement("div");row.className="slotRow";
      if(i%6===0) row.classList.add("major");
      row.dataset.slotIndex=String(i);
      slotsWrap.appendChild(row);
    }
    col.appendChild(slotsWrap);return col;
  }
  function renderGrid(){
    weekGridEl.innerHTML="";dayCols=[];
    const totalMinutes=(CONFIG.endHour-CONFIG.startHour)*60;
    const totalSlots=Math.floor(totalMinutes/CONFIG.stepMinutes);
    weekGridEl.appendChild(buildTimeColumn());
    for(const dayIso of dayIsoList){
      const col=buildDayColumn(dayIso,totalSlots);
      dayCols.push(col);weekGridEl.appendChild(col);
    }
    const slotH=parseFloat(getComputedStyle(document.documentElement).getPropertyValue("--slotH"));
    const gridHeightPx=totalSlots*slotH;
    for(const c of [weekGridEl.querySelector(".timeCol"), ...dayCols]) c.style.minHeight=gridHeightPx+"px";
  }

  function yFromMinutes(mins){
    const slotH=parseFloat(getComputedStyle(document.documentElement).getPropertyValue("--slotH"));
    return (mins/CONFIG.stepMinutes)*slotH;
  }
  function setEventElementGeometry(el, startM, endM){
    const topY = yFromMinutes(startM);
    const hY = yFromMinutes(Math.max(0, endM - startM));
    el.style.top = (topY+2) + "px";
    el.style.height = Math.max(18, hY-4) + "px";
  }

  function overlapsExistingMinutes(dayIso, startM, endM, ignoreId=null){
    for(const ev of state.events){
      if(ev.id===ignoreId) continue;
      if(ev.day!==dayIso) continue;
      const es=clampMinutesToDay(minutesFromDayStart(new Date(ev.start), dayIso));
      const ee=clampMinutesToDay(minutesFromDayStart(new Date(ev.end), dayIso));
      if(startM < ee && endM > es) return true;
    }
    return false;
  }

  function getSlotsRectForDay(dayIso){
    const col = dayCols.find(c=>c.dataset.dayIso===dayIso);
    if(!col) return null;
    const slots = col.querySelector(".slots");
    const rect = slots.getBoundingClientRect();
    return {col, slots, rect};
  }
  function minutesFromClientY(dayIso, clientY){
    const info = getSlotsRectForDay(dayIso);
    if(!info) return 0;
    const slotH=parseFloat(getComputedStyle(document.documentElement).getPropertyValue("--slotH"));
    let y = clientY - info.rect.top;
    if (y < 0) y = 0;
    const maxY = info.rect.height;
    if (y > maxY) y = maxY;
    const rawMins = (y / slotH) * CONFIG.stepMinutes;
    return clampMinutesToDay(rawMins);
  }

  /* ===== Selection highlight ===== */
  function renderSelection(){
    if(state.view!=="calendar") return;
    for(const col of dayCols) col.querySelectorAll(".selectionBlock").forEach(n=>n.remove());
    if(!state.selection) return;
    const {dayIso,start,end}=state.selection;
    const col=dayCols.find(c=>c.dataset.dayIso===dayIso); if(!col) return;

    const topM=clampMinutesToDay(minutesFromDayStart(start,dayIso));
    const endM=clampMinutesToDay(minutesFromDayStart(end,dayIso));
    const durM=Math.max(0,endM-topM);

    const block=document.createElement("div");
    block.className="selectionBlock";
    block.style.top=(yFromMinutes(topM)+2)+"px";
    block.style.height=Math.max(18,yFromMinutes(durM)-4)+"px";

    const hint=document.createElement("div");
    hint.className="selectionHint";
    hint.textContent=`${formatTimeFromMinutes(topM)} → ${formatTimeFromMinutes(endM)}`;
    block.appendChild(hint);
    col.appendChild(block);
  }

  /* =========================================================
     Drag/Resize em eventos
     ========================================================= */
  const EDGE_PX = 10;
  const DRAG_THRESHOLD_PX = 3;

  const eventDrag = {
    pending:false,
    active:false,
    mode:null,          // "move" | "resize-top" | "resize-bottom"
    evId:null,
    dayIso:null,
    el:null,
    origStartM:0,
    origEndM:0,
    downClientY:0,
    pointerStartM:0,
    lastStartM:0,
    lastEndM:0,
    justFinished:false
  };

  function beginEventPending(e, el, ev){
    if(state.view!=="calendar") return;
    const r = el.getBoundingClientRect();
    const y = e.clientY - r.top;

    let mode="move";
    if (y <= EDGE_PX) mode="resize-top";
    else if (y >= r.height - EDGE_PX) mode="resize-bottom";

    const dayIso = ev.day;
    const startM = clampMinutesToDay(minutesFromDayStart(new Date(ev.start), dayIso));
    const endM   = clampMinutesToDay(minutesFromDayStart(new Date(ev.end), dayIso));
    const pointerM = minutesFromClientY(dayIso, e.clientY);

    eventDrag.pending=true;
    eventDrag.active=false;
    eventDrag.mode=mode;
    eventDrag.evId=ev.id;
    eventDrag.dayIso=dayIso;
    eventDrag.el=el;
    eventDrag.origStartM=startM;
    eventDrag.origEndM=endM;
    eventDrag.downClientY=e.clientY;
    eventDrag.pointerStartM=pointerM;
    eventDrag.lastStartM=startM;
    eventDrag.lastEndM=endM;

    drag.active=false;
    state.selection=null;
    renderSelection();
  }

  function activateEventDrag(){
    if(!eventDrag.pending || eventDrag.active) return;
    eventDrag.active=true;
    eventDrag.el.classList.add("dragging");
  }

  function cancelEventDragState(){
    eventDrag.pending=false;
    eventDrag.active=false;
    eventDrag.mode=null;
    eventDrag.evId=null;
    eventDrag.dayIso=null;
    eventDrag.el=null;
    eventDrag.origStartM=0;
    eventDrag.origEndM=0;
    eventDrag.downClientY=0;
    eventDrag.pointerStartM=0;
    eventDrag.lastStartM=0;
    eventDrag.lastEndM=0;
  }

  function onEventDragMove(e){
    if(state.view!=="calendar") return;
    if(!eventDrag.pending) return;

    const movedPx = Math.abs(e.clientY - eventDrag.downClientY);
    if(!eventDrag.active){
      if(movedPx < DRAG_THRESHOLD_PX) return;
      activateEventDrag();
    }

    e.preventDefault();

    const dayIso = eventDrag.dayIso;
    const curPointerM = minutesFromClientY(dayIso, e.clientY);
    let deltaM = normalizeToStepMinutes(curPointerM - eventDrag.pointerStartM);

    const step = CONFIG.stepMinutes;
    let newStart = eventDrag.origStartM;
    let newEnd   = eventDrag.origEndM;

    if(eventDrag.mode==="move"){
      const dur = eventDrag.origEndM - eventDrag.origStartM;
      newStart = eventDrag.origStartM + deltaM;
      newEnd   = newStart + dur;

      if(newStart < 0){ newStart = 0; newEnd = dur; }
      if(newEnd > 1440){ newEnd = 1440; newStart = 1440 - dur; }

      newStart = clampMinutesToDay(newStart);
      newEnd   = clampMinutesToDay(newStart + dur);
      if(newEnd > 1440){ newEnd = 1440; newStart = 1440 - dur; newStart = clampMinutesToDay(newStart); }
    }else if(eventDrag.mode==="resize-top"){
      newStart = eventDrag.origStartM + deltaM;
      newStart = clampMinutesToDay(newStart);
      if(newStart > newEnd - step) newStart = newEnd - step;
      if(newStart < 0) newStart = 0;
      newStart = clampMinutesToDay(newStart);
    }else if(eventDrag.mode==="resize-bottom"){
      newEnd = eventDrag.origEndM + deltaM;
      newEnd = clampMinutesToDay(newEnd);
      if(newEnd < newStart + step) newEnd = newStart + step;
      if(newEnd > 1440) newEnd = 1440;
      newEnd = clampMinutesToDay(newEnd);
    }

    eventDrag.lastStartM = newStart;
    eventDrag.lastEndM   = newEnd;

    setEventElementGeometry(eventDrag.el, newStart, newEnd);

    const timesEl = eventDrag.el.querySelector(".times");
    if(timesEl) timesEl.textContent = `${formatTimeFromMinutes(newStart)} → ${formatTimeFromMinutes(newEnd)}`;
  }

  function onEventDragEnd(){
    if(state.view!=="calendar") { cancelEventDragState(); return; }
    if(!eventDrag.pending) return;

    const wasDragging = eventDrag.active;
    const el = eventDrag.el;
    const evId = eventDrag.evId;
    const dayIso = eventDrag.dayIso;

    if(!wasDragging){
      const id = evId;
      cancelEventDragState();
      openEditModal(id);
      return;
    }

    const newStartM = eventDrag.lastStartM;
    const newEndM   = eventDrag.lastEndM;

    const step = CONFIG.stepMinutes;
    const okDuration = (newEndM - newStartM) >= step;
    let ok = okDuration;

    if(ok && overlapsExistingMinutes(dayIso, newStartM, newEndM, evId)){
      ok=false;
      alert("Conflito: já existe evento nesse intervalo (sobreposição não permitida).");
    }
    if(!okDuration){
      ok=false;
      alert("Não é permitido evento com duração zero.");
    }

    if(ok){
      const idx = state.events.findIndex(x=>x.id===evId);
      if(idx>=0){
        const day = parseISOToLocalDate(dayIso);
        const start = setTimeOnDate(day, Math.floor(newStartM/60), newStartM%60);
        let end;
        if(newEndM===1440){
          const next = addDays(day,1);
          end = setTimeOnDate(next,0,0);
        }else{
          end = setTimeOnDate(day, Math.floor(newEndM/60), newEndM%60);
        }
        state.events[idx] = {...state.events[idx], start:start.toISOString(), end:end.toISOString()};
        saveEvents();
      }
    }else{
      setEventElementGeometry(el, eventDrag.origStartM, eventDrag.origEndM);
      const timesEl = el.querySelector(".times");
      if(timesEl) timesEl.textContent = `${formatTimeFromMinutes(eventDrag.origStartM)} → ${formatTimeFromMinutes(eventDrag.origEndM)}`;
    }

    el.classList.remove("dragging");
    cancelEventDragState();

    eventDrag.justFinished=true;
    setTimeout(()=>{eventDrag.justFinished=false;}, 120);

    renderAll();
  }

  /* ===== Render events ===== */
  function renderEvents(){
    if(state.view!=="calendar") return;
    for(const col of dayCols) col.querySelectorAll(".event").forEach(e=>e.remove());
    const wsIso=toDateOnlyISO(state.weekStart), weIso=toDateOnlyISO(addDays(state.weekStart,6));
    const inWeek=state.events.filter(ev=>ev.day>=wsIso && ev.day<=weIso);

    for(const ev of inWeek){
      const col=dayCols.find(c=>c.dataset.dayIso===ev.day); if(!col) continue;
      const start=new Date(ev.start), end=new Date(ev.end);
      const topM=clampMinutesToDay(minutesFromDayStart(start,ev.day));
      const endM=clampMinutesToDay(minutesFromDayStart(end,ev.day));

      const el=document.createElement("div");
      el.className="event";
      el.dataset.eventId=ev.id;
      el.dataset.dayIso=ev.day;
      setEventElementGeometry(el, topM, endM);

      const pDigit = projectColorDigit(ev.project);

      el.innerHTML=`
        <div class="topline">
          <div class="badge" data-pcolor="${pDigit}">Projeto ${escapeHtml(ev.project||"")}</div>
          <div class="times">${formatTimeFromMinutes(topM)} → ${formatTimeFromMinutes(endM)}</div>
        </div>
        <div class="title">${escapeHtml(ev.activityLabel||"")}${ev.activityId?(" · ID "+escapeHtml(ev.activityId)):""}</div>
        <div class="notes">${escapeHtml(ev.notes||"")}</div>
      `;

      el.addEventListener("mousemove",(e)=>{
        if(eventDrag.active) return;
        const r = el.getBoundingClientRect();
        const y = e.clientY - r.top;
        if (y <= EDGE_PX || y >= r.height - EDGE_PX) el.style.cursor = "ns-resize";
        else el.style.cursor = "grab";
      });
      el.addEventListener("mouseleave",()=>{ if(!eventDrag.active) el.style.cursor="pointer"; });

      el.addEventListener("mousedown",(e)=>{
        if(e.button !== 0) return;
        if(modalBackdrop.classList.contains("show")) return;
        e.stopPropagation();
        beginEventPending(e, el, ev);
      });

      el.addEventListener("click",(e)=>{
        if(eventDrag.justFinished) return;
        e.stopPropagation();
        openEditModal(ev.id);
      });

      col.appendChild(el);
    }
  }

  /* ===== Render tabela (visão alternativa) ===== */
  function minutesToHHMM(mins){
    mins=Math.max(0,Math.round(mins));
    const hh=Math.floor(mins/60), mm=mins%60;
    return pad2(hh)+":"+pad2(mm);
  }
  function getWeekEventsSorted(){
    const wsIso=toDateOnlyISO(state.weekStart), weIso=toDateOnlyISO(addDays(state.weekStart,6));
    return state.events
      .filter(ev=>ev.day>=wsIso && ev.day<=weIso)
      .slice()
      .sort((a,b)=>new Date(a.start)-new Date(b.start));
  }
  function renderTable(){
    if(state.view!=="table") return;

    tableBodyEl.innerHTML="";
    const inWeek = getWeekEventsSorted();

    for(const ev of inWeek){
      const day = parseISOToLocalDate(ev.day);
      const start = new Date(ev.start);
      const end = new Date(ev.end);

      const sM = clampMinutesToDay(minutesFromDayStart(start, ev.day));
      const eM = clampMinutesToDay(minutesFromDayStart(end, ev.day));

      const data = formatDateBR(day);
      const horaIni = formatTimeFromMinutes(sM);
      const horaFim = formatTimeFromMinutes(eM);
      const esforco = minutesToHHMM(Math.max(0, durationMinutes(start,end)));
      const esforcoDia = formatWorkedHM(sumWorkedMinutesForDay(ev.day));

      const pDigit = projectColorDigit(ev.project);

      const tr = document.createElement("tr");
      tr.dataset.eventId = ev.id;
      tr.innerHTML = `
        <td class="tdMono">${escapeHtml(data)}</td>
        <td>
          <span class="tagProject">
            <span class="badge" data-pcolor="${pDigit}">Projeto ${escapeHtml(ev.project||"")}</span>
          </span>
        </td>
        <td class="tdMono">${escapeHtml(horaIni)}</td>
        <td class="tdMono">${escapeHtml(horaFim)}</td>
        <td class="tdMono">${escapeHtml(esforco)}</td>
        <td class="tdMono">${escapeHtml(esforcoDia)}</td>
        <td>${escapeHtml(ev.activityLabel||"")}</td>
        <td class="tdNotes">${escapeHtml(ev.notes||"")}</td>
        <td class="tdMono">${escapeHtml(ev.activityId||"")}</td>
      `;
      tr.addEventListener("click",()=>openEditModal(ev.id));
      tableBodyEl.appendChild(tr);
    }

    if(inWeek.length===0){
      const tr=document.createElement("tr");
      tr.innerHTML=`<td colspan="9" class="tdMuted">Nenhum evento nesta semana.</td>`;
      tableBodyEl.appendChild(tr);
    }
  }

  

  /* ===== Render Gantt (por projeto na semana) ===== */
  function getProjectsInWeek(){
    const inWeek = getWeekEventsSorted();
    const set = new Set();
    for(const ev of inWeek){
      const p = (ev.project||"").trim();
      if(p) set.add(p);
    }
    return Array.from(set).sort((a,b)=>{
      const na = Number(a), nb = Number(b);
      if(!Number.isNaN(na) && !Number.isNaN(nb)) return na-nb;
      return a.localeCompare(b);
    });
  }

  function ensureGanttFilterOptions(){
    const projects = getProjectsInWeek();
    const prev = ganttProjectFilterEl.value || "ALL";

    ganttProjectFilterEl.innerHTML = "";
    const optAll = document.createElement("option");
    optAll.value = "ALL";
    optAll.textContent = "Todos os projetos";
    ganttProjectFilterEl.appendChild(optAll);

    for(const p of projects){
      const o = document.createElement("option");
      o.value = p;
      o.textContent = p;
      ganttProjectFilterEl.appendChild(o);
    }

    if(prev && (prev==="ALL" || projects.includes(prev))){
      ganttProjectFilterEl.value = prev;
    }else{
      ganttProjectFilterEl.value = "ALL";
    }
    return projects;
  }

  function renderGantt(){
    if(state.view!=="gantt") return;

    const projects = ensureGanttFilterOptions();
    const filter = ganttProjectFilterEl.value || "ALL";

    ganttBodyEl.innerHTML = "";

    const ws = state.weekStart;
    const days = [];
    for(let i=0;i<7;i++){
      const d = addDays(ws,i);
      days.push(toDateOnlyISO(d));
    }

    const inWeek = getWeekEventsSorted();

    // acumula minutos por projeto/dia
    const map = new Map(); // project -> { totalWeek, byDay: {dayIso: mins}}
    for(const ev of inWeek){
      const p = (ev.project||"").trim();
      if(!p) continue;
      if(filter!=="ALL" && p!==filter) continue;

      const start = new Date(ev.start);
      const end = new Date(ev.end);
      const dur = Math.max(0, durationMinutes(start,end));

      const m = map.get(p) || { totalWeek:0, byDay:{} };
      m.totalWeek += dur;
      m.byDay[ev.day] = (m.byDay[ev.day]||0) + dur;
      map.set(p,m);
    }

    const rows = Array.from(map.entries())
      .sort((a,b)=>{
        const na=Number(a[0]), nb=Number(b[0]);
        if(!Number.isNaN(na) && !Number.isNaN(nb)) return na-nb;
        return a[0].localeCompare(b[0]);
      });

    if(rows.length===0){
      const tr=document.createElement("tr");
      tr.innerHTML = `<td class="left tdMuted" colspan="9">Nenhum evento nesta semana.</td>`;
      ganttBodyEl.appendChild(tr);
      return;
    }

    for(const [project, info] of rows){
      const tr = document.createElement("tr");

      const totalWeek = minutesToHHMM(info.totalWeek);

      let tds = `
        <td class="left tdMono">${escapeHtml(project)}</td>
        <td class="tdMono">${escapeHtml(totalWeek)}</td>
      `;

      for(const dayIso of days){
        const mins = info.byDay[dayIso] || 0;
        if(mins>0){
          tds += `<td class="gCell on"><span>${escapeHtml(minutesToHHMM(mins))}</span></td>`;
        }else{
          tds += `<td class="gCell tdMuted"> </td>`;
        }
      }

      tr.innerHTML = tds;
      ganttBodyEl.appendChild(tr);
    }
  }

  function setActiveViewButtons(){
    btnViewCalendar.classList.toggle("active", state.view==="calendar");
    btnViewTable.classList.toggle("active", state.view==="table");
    btnViewGantt.classList.toggle("active", state.view==="gantt");
  }

  function renderAll(){
    renderHeader();
    setActiveViewButtons();

    if(state.view==="calendar"){
      daysHeaderEl.classList.remove("hidden");
      calendarViewEl.classList.remove("hidden");
      tableViewEl.classList.add("hidden");
      ganttViewEl.classList.add("hidden");

      renderGrid();
      renderEvents();
      renderSelection();
    }else if(state.view==="table"){
      daysHeaderEl.classList.add("hidden");
      calendarViewEl.classList.add("hidden");
      tableViewEl.classList.remove("hidden");
      ganttViewEl.classList.add("hidden");

      // Evita estados pendentes de drag/selection
      state.selection=null;
      cancelEventDragState();
      drag.active=false;

      renderTable();
    }else{
      // gantt
      daysHeaderEl.classList.add("hidden");
      calendarViewEl.classList.add("hidden");
      tableViewEl.classList.add("hidden");
      ganttViewEl.classList.remove("hidden");

      state.selection=null;
      cancelEventDragState();
      drag.active=false;

      renderGantt();
    }
  }

  /* ===== Selection by drag on empty grid ===== */
  let drag={active:false,dayIso:null,startSlot:null,currentSlot:null};
  function slotFromEventTarget(target){
    const row=target.closest(".slotRow"); if(!row) return null;
    const col=row.closest(".dayCol"); if(!col) return null;
    return {dayIso:col.dataset.dayIso, slotIndex:parseInt(row.dataset.slotIndex,10)};
  }
  function dateFromDayAndSlot(dayIso,slotIndex){
    const day=parseISOToLocalDate(dayIso);
    const mins=slotIndex*CONFIG.stepMinutes;
    if(mins===1440){const next=addDays(day,1);return setTimeOnDate(next,0,0);}
    return setTimeOnDate(day, Math.floor(mins/60), mins%60);
  }

  const weekGridElRef=weekGridEl;
  let handlersBound=false;
  function bindGlobalHandlersOnce(){
    if(handlersBound) return; handlersBound=true;

    weekGridElRef.addEventListener("mousedown", onMouseDownGrid);
    window.addEventListener("mousemove", onMouseMoveGlobal);
    window.addEventListener("mouseup", onMouseUpGlobal);

    window.addEventListener("mousemove", onEventDragMove, {passive:false});
    window.addEventListener("mouseup", onEventDragEnd);
  }

  function onMouseDownGrid(e){
    if(state.view!=="calendar") return;
    if(e.target.closest(".event")) return;
    if(eventDrag.pending) return;
    const hit=slotFromEventTarget(e.target); if(!hit) return;
    e.preventDefault();
    drag.active=true;drag.dayIso=hit.dayIso;drag.startSlot=hit.slotIndex;drag.currentSlot=hit.slotIndex;
    const start=dateFromDayAndSlot(drag.dayIso,drag.startSlot);
    const end=dateFromDayAndSlot(drag.dayIso,drag.startSlot+1);
    state.selection={dayIso:drag.dayIso,start,end};renderSelection();
  }
  function onMouseMoveGlobal(e){
    if(state.view!=="calendar") return;
    if(!drag.active) return;
    const hit=slotFromEventTarget(e.target); if(!hit || hit.dayIso!==drag.dayIso) return;
    drag.currentSlot=hit.slotIndex;

    const totalSlots=Math.floor(((CONFIG.endHour-CONFIG.startHour)*60)/CONFIG.stepMinutes);
    const a=drag.startSlot, b=drag.currentSlot;
    let startSlot=Math.min(a,b), endSlot=Math.max(a,b)+1;
    startSlot=Math.max(0,Math.min(totalSlots-1,startSlot));
    endSlot=Math.max(1,Math.min(totalSlots,endSlot));

    const start=dateFromDayAndSlot(drag.dayIso,startSlot);
    const end=dateFromDayAndSlot(drag.dayIso,endSlot);
    state.selection={dayIso:drag.dayIso,start,end};renderSelection();
  }
  function onMouseUpGlobal(){
    if(state.view!=="calendar") return;
    if(!drag.active) return;
    drag.active=false;
    if(!state.selection) return;
    if(durationMinutes(state.selection.start,state.selection.end)<=0){state.selection=null;renderSelection();return;}
    openCreateModalFromSelection();
  }

  /* =========================================================
     Modal
     ========================================================= */
  const modalBackdrop=document.getElementById("modalBackdrop");
  const modalTitleEl=document.getElementById("modalTitle");
  const modalWhenEl=document.getElementById("modalWhen");
  const modalInfoEl=document.getElementById("modalInfo");
  const modalInfoTextEl=document.getElementById("modalInfoText");

  const startTimeSelectEl=document.getElementById("startTimeSelect");
  const endTimeSelectEl=document.getElementById("endTimeSelect");
  const projectInputEl=document.getElementById("projectInput");
  const activityNameSelectEl=document.getElementById("activityNameSelect");
  const activityIdInputEl=document.getElementById("activityIdInput");
  const notesInputEl=document.getElementById("notesInput");
  const btnCopyFieldsEl=document.getElementById("btnCopyFields");
  const btnPasteFieldsEl=document.getElementById("btnPasteFields");
  const idLookupPill=document.getElementById("idLookupPill");
  const idLookupText=document.getElementById("idLookupText");
  const btnDelete=document.getElementById("btnDelete");

  function setModalInfo(msg){
    if(!msg){modalInfoEl.classList.add("hidden");modalInfoTextEl.textContent="";return;}
    modalInfoEl.classList.remove("hidden");modalInfoTextEl.textContent=msg;
  }
  
  function updatePasteButtonState(){
    const clip = getClipboardFields();
    const has = !!(clip && (clip.project || clip.activityLabel || clip.activityId || clip.notes));
    if(btnPasteFieldsEl) btnPasteFieldsEl.disabled = !has;
  }

  function showModal(show){
    if(show){
      modalBackdrop.classList.add("show");
      modalBackdrop.setAttribute("aria-hidden","false");
      setModalInfo("");
      updatePasteButtonState();
      setTimeout(()=>projectInputEl.focus(),0);
    }else{
      modalBackdrop.classList.remove("show");
      modalBackdrop.setAttribute("aria-hidden","true");
    }
  }
  function setIdLookupStatus(kind,text){
    idLookupPill.classList.remove("ok","warn");
    idLookupPill.classList.add(kind==="ok"?"ok":"warn");
    idLookupText.textContent=text;
  }
  function buildTimeOptions(){
    startTimeSelectEl.innerHTML=""; endTimeSelectEl.innerHTML="";
    for(let m=0;m<=1430;m+=CONFIG.stepMinutes){
      const opt=document.createElement("option");opt.value=String(m);opt.textContent=formatTimeFromMinutes(m);
      startTimeSelectEl.appendChild(opt);
    }
    for(let m=10;m<=1440;m+=CONFIG.stepMinutes){
      const opt=document.createElement("option");opt.value=String(m);opt.textContent=formatTimeFromMinutes(m);
      endTimeSelectEl.appendChild(opt);
    }
  }
  function fillActivityNames(){
    activityNameSelectEl.innerHTML="";
    for(const name of ACTIVITY_NAMES){
      const opt=document.createElement("option");opt.value=name;opt.textContent=name;
      activityNameSelectEl.appendChild(opt);
    }
  }
  function resetModalFields(){
    projectInputEl.value="";
    activityNameSelectEl.value=ACTIVITY_NAMES[0]||"";
    activityIdInputEl.value="";
    notesInputEl.value="";
    setIdLookupStatus("warn", state.idBaseIndex ? "ID: selecione projeto e atividade" : "ID: preencha manualmente (base não consultada)");
  }
  function setTimeSelectorsFromSelection(dayIso,start,end){
    const sM=clampMinutesToDay(minutesFromDayStart(start,dayIso));
    const eM=clampMinutesToDay(minutesFromDayStart(end,dayIso));
    startTimeSelectEl.value=String(Math.min(1430,sM));
    endTimeSelectEl.value=String(Math.max(10,Math.min(1440,eM)));
  }
  function selectionFromTimeSelectors(dayIso){
    let sM=clampMinutesToDay(parseInt(startTimeSelectEl.value||"0",10));
    let eM=clampMinutesToDay(parseInt(endTimeSelectEl.value||"10",10));
    if(sM>=1440) sM=1430;
    if(eM<=0) eM=10;
    if(eM<=sM) eM=Math.min(1440, sM+CONFIG.stepMinutes);

    const day=parseISOToLocalDate(dayIso);
    const start=setTimeOnDate(day, Math.floor(sM/60), sM%60);
    let end;
    if(eM===1440){const next=addDays(day,1); end=setTimeOnDate(next,0,0);}
    else end=setTimeOnDate(day, Math.floor(eM/60), eM%60);
    return {dayIso,start,end};
  }
  function refreshModalWhen(){
    if(!state.selection) return;
    const sel=state.selection;
    modalWhenEl.textContent=`${formatDateTimeBRFromDay(sel.start,sel.dayIso)} → ${formatDateTimeBRFromDay(sel.end,sel.dayIso)}`;
  }
  function overlapsExisting(dayIso,start,end,ignoreId=null){
    const s=minutesFromDayStart(start,dayIso), e=minutesFromDayStart(end,dayIso);
    for(const ev of state.events){
      if(ev.id===ignoreId) continue;
      if(ev.day!==dayIso) continue;
      const es=minutesFromDayStart(new Date(ev.start),dayIso);
      const ee=minutesFromDayStart(new Date(ev.end),dayIso);
      if(s<ee && e>es) return true;
    }
    return false;
  }
  function genId(){return "ev_"+Math.random().toString(16).slice(2)+"_"+Date.now().toString(16)}

  function lookupIdFor(project,activityName){
    if(!state.idBaseIndex) return "";
    const p=normKey(project), a=normKey(activityName);
    if(!p || !a) return "";
    const hit1=state.idBaseIndex[`${p}||${a}`];
    if(hit1) return String(hit1);
    const pn=String(project).match(/\b(\d{3,})\b/)?.[1]||"";
    if(pn){
      const hit2=state.idBaseIndex[`${normKey(pn)}||${a}`];
      if(hit2) return String(hit2);
    }
    return "";
  }
  function maybeAutoFillId(){
    const project=(projectInputEl.value||"").trim();
    const activityName=(activityNameSelectEl.value||"").trim();
    if(!state.idBaseIndex){setIdLookupStatus("warn","ID: preencha manualmente (base não consultada)");return;}
    if(!project || !activityName){setIdLookupStatus("warn","ID: selecione projeto e atividade");return;}
    const found=lookupIdFor(project,activityName);
    if(found){
      activityIdInputEl.value=found;
      setIdLookupStatus("ok","ID preenchido automaticamente pela base");
    }else{
      // Se a combinação Projeto + Atividade não existir na base carregada, sempre limpa o ID
      activityIdInputEl.value="";
      setIdLookupStatus("warn","ID não encontrado — campo limpo");
    }
  }

  function openCreateModalFromSelection(){
    state.editingEventId=null;
    btnDelete.classList.add("hidden");
    modalTitleEl.textContent="Novo evento";
    const sel=state.selection; if(!sel) return;
    setTimeSelectorsFromSelection(sel.dayIso,sel.start,sel.end);
    refreshModalWhen();
    resetModalFields();
    showModal(true);
    maybeAutoFillId();
  }
  function openCreateModalFromTable(){
    // Cria um apontamento "em branco" a partir da visão de tabela
    state.editingEventId=null;
    btnDelete.classList.add("hidden");
    modalTitleEl.textContent="Novo evento";

    // Dia padrão: se "hoje" está na semana exibida, usa hoje; senão, usa o primeiro dia da semana exibida
    const today=new Date();
    const weekStart=new Date(state.weekStart);
    const weekEnd=addDays(weekStart,6);
    const day=(today>=weekStart && today<=weekEnd) ? today : weekStart;

    // --- CORREÇÃO AQUI: formatISODate(day) não existia. Substituído por toDateOnlyISO(day) ---
    const dayIso=toDateOnlyISO(day);

    // Hora padrão: arredonda para o próximo step e cria 1h (ou 30min) de duração
    const nowMin=today.getHours()*60+today.getMinutes();
    const step=CONFIG.stepMinutes;
    let startMin=Math.ceil(nowMin/step)*step;
    startMin=Math.max(CONFIG.startHour*60, Math.min(1430, startMin));
    let endMin=Math.min(1440, startMin+60);
    if(endMin<=startMin) endMin=Math.min(1440, startMin+step);

    const dayLocal=parseISOToLocalDate(dayIso);
    const start=setTimeOnDate(dayLocal, Math.floor(startMin/60), startMin%60);
    let end;
    if(endMin===1440){const next=addDays(dayLocal,1); end=setTimeOnDate(next,0,0);}
    else end=setTimeOnDate(dayLocal, Math.floor(endMin/60), endMin%60);

    state.selection={dayIso,start,end};
    setTimeSelectorsFromSelection(dayIso,start,end);
    refreshModalWhen();
    resetModalFields();
    showModal(true);
    maybeAutoFillId();
  }


  function openEditModal(eventId){
    const ev=state.events.find(x=>x.id===eventId); if(!ev) return;
    state.editingEventId=eventId;
    btnDelete.classList.remove("hidden");
    modalTitleEl.textContent="Editar evento";
    const start=new Date(ev.start), end=new Date(ev.end);
    state.selection={dayIso:ev.day,start,end};
    setTimeSelectorsFromSelection(ev.day,start,end);
    refreshModalWhen();
    if(state.view==="calendar") renderSelection();

    projectInputEl.value=ev.project||"";
    const act=ev.activityLabel||"";
    if(act && !ACTIVITY_NAMES.includes(act)){
      const opt=document.createElement("option");opt.value=act;opt.textContent=act;
      activityNameSelectEl.appendChild(opt);
    }
    activityNameSelectEl.value=act || (ACTIVITY_NAMES[0]||"");
    activityIdInputEl.value=ev.activityId||"";
    notesInputEl.value=ev.notes||"";
    showModal(true);
    maybeAutoFillId();
  }
  function closeModalDiscardSelection(){
    showModal(false);
    if(!state.editingEventId){state.selection=null; if(state.view==="calendar") renderSelection();}
    state.editingEventId=null;
  }

  function onSave(){
    if(!state.selection){setModalInfo("Seleção inválida. Feche e selecione novamente.");return;}
    const dayIso=state.selection.dayIso;
    const sel=selectionFromTimeSelectors(dayIso);
    state.selection=sel;
    if(durationMinutes(sel.start,sel.end)<=0){setModalInfo("Não é permitido evento com duração zero.");return;}

    const project=(projectInputEl.value||"").trim();
    const activityLabel=(activityNameSelectEl.value||"").trim();
    const activityId=(activityIdInputEl.value||"").trim();
    const notes=(notesInputEl.value||"").trim();

    if(!project){setModalInfo("Informe o projeto.");return;}
    if(!activityLabel){setModalInfo("Selecione uma atividade.");return;}
    if(!activityId){setModalInfo("Informe o ID da atividade.");return;}
    if(overlapsExisting(dayIso,sel.start,sel.end,state.editingEventId)){
      setModalInfo("Conflito: já existe evento nesse intervalo (sobreposição não permitida).");return;
    }

    if(state.editingEventId){
      const idx=state.events.findIndex(e=>e.id===state.editingEventId);
      if(idx>=0){
        state.events[idx]={...state.events[idx],start:sel.start.toISOString(),end:sel.end.toISOString(),day:dayIso,project,activityId,activityLabel,notes};
      }
    }else{
      state.events.push({id:genId(),start:sel.start.toISOString(),end:sel.end.toISOString(),day:dayIso,project,activityId,activityLabel,notes});
    }

    saveEvents();
    showModal(false);
    state.selection=null;
    state.editingEventId=null;
    renderAll();
  }

  function onDelete(){
    if(!state.editingEventId) return;
    state.events=state.events.filter(e=>e.id!==state.editingEventId);
    saveEvents();
    showModal(false);
    state.selection=null;
    state.editingEventId=null;
    renderAll();
  }

  startTimeSelectEl.addEventListener("change",()=>{if(!state.selection)return;state.selection=selectionFromTimeSelectors(state.selection.dayIso);refreshModalWhen(); if(state.view==="calendar") renderSelection();});
  endTimeSelectEl.addEventListener("change",()=>{if(!state.selection)return;state.selection=selectionFromTimeSelectors(state.selection.dayIso);refreshModalWhen(); if(state.view==="calendar") renderSelection();});
  projectInputEl.addEventListener("input",()=>{clearTimeout(projectInputEl._t);projectInputEl._t=setTimeout(maybeAutoFillId,120);});
  activityNameSelectEl.addEventListener("change", maybeAutoFillId);

  // Copiar/Colar campos do evento (Projeto/Atividade/ID/Observação)
  if(btnCopyFieldsEl) btnCopyFieldsEl.addEventListener("click", ()=>{
    const payload = {
      project: (projectInputEl.value||"").trim(),
      activityLabel: (activityNameSelectEl.value||"").trim(),
      activityId: (activityIdInputEl.value||"").trim(),
      notes: (notesInputEl.value||"").trim()
    };
    setClipboardFields(payload);
    updatePasteButtonState();
    setModalInfo("Campos copiados. Abra outro evento e clique em Colar.", false);
  });
  if(btnPasteFieldsEl) btnPasteFieldsEl.addEventListener("click", ()=>{
    const clip = getClipboardFields();
    if(!clip){ updatePasteButtonState(); return; }
    projectInputEl.value = clip.project || "";
    ensureSelectHasValue(activityNameSelectEl, clip.activityLabel || "");
    if(clip.activityLabel) activityNameSelectEl.value = clip.activityLabel;
    activityIdInputEl.value = clip.activityId || "";
    notesInputEl.value = clip.notes || "";
    setIdLookupStatus("ok","ID colado (não alterado)");
    setModalInfo("Campos colados.");
  });

  document.getElementById("modalClose").addEventListener("click", closeModalDiscardSelection);
  document.getElementById("btnCancel").addEventListener("click", closeModalDiscardSelection);
  document.getElementById("btnSave").addEventListener("click", onSave);
  document.getElementById("btnDelete").addEventListener("click", onDelete);

  modalBackdrop.addEventListener("click",(e)=>{ if(e.target===modalBackdrop) closeModalDiscardSelection(); });
  window.addEventListener("keydown",(e)=>{ if(e.key==="Escape" && modalBackdrop.classList.contains("show")) closeModalDiscardSelection(); });

  /* =========================================================
     CSV Export (UTF-8 + BOM) — compatível com Excel (pt-BR)
     - Usa ";" como separador (padrão do Excel no Brasil)
     - Colunas na ordem solicitada
     ========================================================= */
  const btnExportCsv=document.getElementById("btnExportCsv");
  const EXPORT_EMAIL="andre.baptista@exxata.com.br";

  // Escapa valores para CSV com separador ";"
  function csvEscape(v){
    const s=String(v??"");
    // se contiver aspas, quebras de linha ou o separador, envolve em aspas e duplica aspas internas
    if(/[\"\n\r;]/.test(s)) return '"' + s.replaceAll('"','""') + '"';
    return s;
  }
  function getStartHHMM(ev){
    const start=new Date(ev.start);
    const m=clampMinutesToDay(minutesFromDayStart(start, ev.day));
    return formatTimeFromMinutes(m);
  }
  function getEndHHMM(ev){
    const end=new Date(ev.end);
    const m=clampMinutesToDay(minutesFromDayStart(end, ev.day));
    return formatTimeFromMinutes(m);
  }

  function exportCsv(){
    const rows=[];

    // Cabeçalho na ordem solicitada
    rows.push([
      "Data",
      "Projeto",
      "Hora Início",
      "Hora de Término",
      "Esforço",
      "Esforço Dia",
      "Atividade",
      "Observação",
      "Artia",
      "ID da Atividade",
      "E-mail"
    ]);

    const sorted=[...state.events].sort((a,b)=>new Date(a.start)-new Date(b.start));

    for(const ev of sorted){
      const dayDate=parseISOToLocalDate(ev.day);
      const data=formatDateBR(dayDate);

      const start=new Date(ev.start);
      const end=new Date(ev.end);

      const durMin=Math.max(0,durationMinutes(start,end));
      const esforco=minutesToHHMM(durMin);

      // soma do total de horas no dia (considerando todos os eventos do mesmo dia)
      const esforcoDia=formatWorkedHM(sumWorkedMinutesForDay(ev.day));

      rows.push([
        data,
        ev.project||"",
        getStartHHMM(ev),
        getEndHHMM(ev),
        esforco,
        esforcoDia,
        ev.activityLabel||"",
        ev.notes||"",
        "",                 // Artia (em branco)
        ev.activityId||"",  // ID da Atividade (ID Artia)
        EXPORT_EMAIL
      ]);
    }

    // ";" para abrir em colunas no Excel pt-BR
    const csvBody=rows.map(r=>r.map(csvEscape).join(";")).join("\n");
    const csvWithBom="\uFEFF"+csvBody;

    const blob=new Blob([csvWithBom],{type:"text/csv;charset=utf-8"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url;
    a.download="apontamento_horas.csv";
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url),0);
  }

  btnExportCsv.addEventListener("click", exportCsv);

  // Botão "Novo apontamento" na visão Tabela (robusto para qualquer ordem de carregamento)
const btnNewFromTable=document.getElementById("btnNewFromTable");
// Expõe o handler no escopo global para evitar problemas de escopo/ordem em browsers mais chatos
window.__openCreateModalFromTable = openCreateModalFromTable;

if(btnNewFromTable){
  btnNewFromTable.type = "button";
  btnNewFromTable.addEventListener("click", (e)=>{
    e.preventDefault();
    e.stopPropagation();
    openCreateModalFromTable();
  });
}

/* =========================================================
     Navegação + Toggle View
     ========================================================= */
  const btnPrev=document.getElementById("btnPrev");
  const btnToday=document.getElementById("btnToday");
  const btnNext=document.getElementById("btnNext");
  const btnClearWeek=document.getElementById("btnClearWeek");
  const btnClearAll=document.getElementById("btnClearAll");

  function goWeek(deltaWeeks){
    state.weekStart=addDays(state.weekStart, deltaWeeks*7);
    state.selection=null;state.editingEventId=null;renderAll();
  }
  function goToday(){
    state.weekStart=startOfWeekMonday(new Date());
    state.selection=null;state.editingEventId=null;renderAll();
    document.getElementById("gridWrap").scrollTop=0;
  }
  btnPrev.addEventListener("click",()=>goWeek(-1));
  btnNext.addEventListener("click",()=>goWeek(1));
  btnToday.addEventListener("click",()=>goToday());
  btnClearWeek.addEventListener("click",()=>{if(confirm("Limpar eventos apenas da semana atual?")) clearWeek();});
  btnClearAll.addEventListener("click",()=>{if(confirm("Limpar TODOS os eventos (todas as semanas)?")) clearAll();});

  
  // Alternância de visão
  btnViewCalendar.addEventListener("click",()=>{
    state.view="calendar";
    renderAll();
  });
  btnViewTable.addEventListener("click",()=>{
    state.view="table";
    renderAll();
  });
  btnViewGantt.addEventListener("click",()=>{
    state.view="gantt";
    renderAll();
  });

  ganttProjectFilterEl.addEventListener("change",()=>{
    if(state.view==="gantt") renderGantt();
  });

  /* =========================================================
     XLSX Import (sem libs)
     ========================================================= */
  const btnLoadBase=document.getElementById("btnLoadBase");
  const fileBaseInput=document.getElementById("fileBaseInput");
  btnLoadBase.addEventListener("click",()=>fileBaseInput.click());

  fileBaseInput.addEventListener("change", async ()=>{
    const file=fileBaseInput.files && fileBaseInput.files[0];
    if(!file) return;
    try{
      setBaseStatus(false,null);baseStatusTextEl.textContent="Base IDs: carregando...";
      const buf=await file.arrayBuffer();
      const zip=await readZipEntries(buf);
      const sharedXml=await zipReadText(zip,"xl/sharedStrings.xml");
      const sheetXml=await zipReadText(zip,"xl/worksheets/sheet1.xml") || await zipReadText(zip,"xl/worksheets/sheet.xml");
      if(!sheetXml) throw new Error("Não encontrei xl/worksheets/sheet1.xml (primeira aba).");

      const shared=sharedXml?parseSharedStrings(sharedXml):[];
      const rows=parseSheetRows(sheetXml, shared);

      const index={};
      for(const r of rows){
        const actA=(r.A??"").trim();
        const idB=(r.B??"").trim();
        const cVal=(r.C??"").trim();
        if(!actA || !idB) continue;

        const proj=extractProjectFromC(cVal)||"";
        if(proj){
          const k=`${normKey(proj)}||${normKey(actA)}`;
          if(!index[k]) index[k]=idB;
        }
        if(proj && cVal){
          const rest=cVal.replace(new RegExp("\\b"+proj+"\\b"),"").replace(/^[-–—\s]+/,"").trim();
          if(rest){
            const k2=`${normKey(proj)}||${normKey(rest)}`;
            if(!index[k2]) index[k2]=idB;
          }
        }
      }

      const meta={rows:rows.length,indexed:Object.keys(index).length,loadedAt:new Date().toISOString(),fileName:file.name};
      saveIdBaseToStorage(index,meta);
      setIdLookupStatus("warn","ID: selecione projeto e atividade");
      maybeAutoFillId();
    }catch(err){
      console.error(err);
      setBaseStatus(false,null);
      alert("Falha ao ler a base XLSX.\n\nConfirme: A=Atividade, B=ID, C=Projeto+Nome.\n\nErro: "+(err?.message||err));
    }finally{
      fileBaseInput.value="";
    }
  });

  function u32(view,off){return view.getUint32(off,true)}
  function u16(view,off){return view.getUint16(off,true)}
  async function readZipEntries(arrayBuffer){
    const view=new DataView(arrayBuffer);
    const len=view.byteLength;
    let eocd=-1;
    for(let i=len-22;i>=Math.max(0,len-65557);i--){if(u32(view,i)===0x06054b50){eocd=i;break;}}
    if(eocd<0) throw new Error("ZIP inválido: EOCD não encontrado.");

    const cdSize=u32(view,eocd+12);
    const cdOff=u32(view,eocd+16);
    let ptr=cdOff;
    const entries=new Map();

    while(ptr<cdOff+cdSize){
      if(u32(view,ptr)!==0x02014b50) break;
      const compMethod=u16(view,ptr+10);
      const compSize=u32(view,ptr+20);
      const uncompSize=u32(view,ptr+24);
      const nameLen=u16(view,ptr+28);
      const extraLen=u16(view,ptr+30);
      const commLen=u16(view,ptr+32);
      const localOff=u32(view,ptr+42);

      const nameBytes=new Uint8Array(arrayBuffer,ptr+46,nameLen);
      const name=new TextDecoder().decode(nameBytes);

      entries.set(name,{name,compMethod,compSize,uncompSize,localOff});
      ptr+=46+nameLen+extraLen+commLen;
    }
    return {buffer:arrayBuffer,view:new DataView(arrayBuffer),entries};
  }
  async function zipReadText(zip,path){
    const entry=zip.entries.get(path);
    if(!entry) return "";
    const data=await zipReadEntry(zip,entry);
    return new TextDecoder("utf-8").decode(data);
  }
  async function zipReadEntry(zip,entry){
    const {view,buffer}=zip;
    const lo=entry.localOff;
    if(u32(view,lo)!==0x04034b50) throw new Error("ZIP inválido: local header ausente para "+entry.name);
    const nameLen=u16(view,lo+26);
    const extraLen=u16(view,lo+28);
    const dataStart=lo+30+nameLen+extraLen;
    const comp=new Uint8Array(buffer,dataStart,entry.compSize);

    if(entry.compMethod===0) return comp;
    if(entry.compMethod===8){
      if(typeof DecompressionStream!=="undefined"){
        const ds=new DecompressionStream("deflate-raw");
        const stream=new Response(comp).body.pipeThrough(ds);
        const ab=await new Response(stream).arrayBuffer();
        return new Uint8Array(ab);
      }
      throw new Error("Seu navegador não suporta DecompressionStream (deflate).");
    }
    throw new Error("Método de compressão ZIP não suportado: "+entry.compMethod);
  }

  function parseSharedStrings(xmlText){
    const doc=new DOMParser().parseFromString(xmlText,"application/xml");
    const sis=doc.getElementsByTagName("si");
    const out=[];
    for(const si of sis){
      const ts=si.getElementsByTagName("t");
      let s=""; for(const t of ts) s+=t.textContent||"";
      out.push(s);
    }
    return out;
  }
  function parseSheetRows(sheetXml,sharedStrings){
    const doc=new DOMParser().parseFromString(sheetXml,"application/xml");
    const rows=doc.getElementsByTagName("row");
    const out=[];
    for(const row of rows){
      const cells=row.getElementsByTagName("c");
      const obj={A:"",B:"",C:""};
      for(const c of cells){
        const r=c.getAttribute("r")||"";
        const col=(r.match(/^[A-Z]+/)||[""])[0];
        if(col!=="A" && col!=="B" && col!=="C") continue;
        const t=c.getAttribute("t");
        const v=c.getElementsByTagName("v")[0]?.textContent ?? "";
        let value="";
        if(t==="s"){value=sharedStrings[parseInt(v,10)] ?? "";}
        else value=v;
        obj[col]=String(value??"").trim();
      }
      if(obj.A || obj.B || obj.C) out.push(obj);
    }
    return out;
  }

  /* ===== init ===== */
  function init(){
    buildTimeOptions();
    fillActivityNames();
    updatePasteButtonState();
    loadIdBaseFromStorage();

    const storageWasEmpty=loadEvents();
    if(storageWasEmpty){
      state.weekStart=startOfWeekMonday(parseISOToLocalDate("2026-01-19"));
    }else{
      const hasExampleWeek=state.events.some(e=>e.day==="2026-01-19");
      if(hasExampleWeek) state.weekStart=startOfWeekMonday(parseISOToLocalDate("2026-01-19"));
    }

    bindGlobalHandlersOnce();
    renderAll();
  }

  init();
</script>
</body>
</html>